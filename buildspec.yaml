version: 0.2

env:
  variables:
    DOTNET_VERSION: 8.0
    SONAR_TOKEN: "b183fb6f93db8c01e2afaff7be009c1386c34b40"
    SONAR_PROJECT_KEY: "Prashanthsraju14_testapi"
    SONAR_ORGANIZATION: "prashanthsraju14"  # ğŸ” Replace with your real SonarCloud org
    SONAR_HOST_URL: "https://sonarcloud.io"

phases:
  install:
    runtime-versions:
      dotnet: $DOTNET_VERSION
    commands:
      - echo "ğŸ“¦ Installing dotnet tools..."
      - export HOME=/root  # âœ… Required for dotnet tool install
      - export PATH="$PATH:/root/.dotnet/tools"
      - dotnet tool install --global dotnet-sonarscanner
      - dotnet tool install --global dotnet-reportgenerator-globaltool
      - echo "ğŸ“ Restoring dependencies..."
      - dotnet restore

  pre_build:
    commands:
      - echo "ğŸ” Starting SonarCloud analysis..."
      - dotnet sonarscanner begin /k:"$SONAR_PROJECT_KEY" /o:"$SONAR_ORGANIZATION" /d:sonar.token="$SONAR_TOKEN" /d:sonar.host.url="$SONAR_HOST_URL" /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"

  build:
    commands:
      - echo "ğŸ› ï¸ Building the project..."
      - dotnet build --no-restore --configuration Release
      - echo "ğŸ§ª Running tests with coverage..."
      - dotnet test ./TestApi.Tests/ --no-build --configuration Release --collect:"XPlat Code Coverage" --results-directory coverage
      - echo "ğŸ“Š Generating HTML coverage report..."
      - reportgenerator -reports:"coverage/**/coverage.cobertura.xml" -targetdir:"coverage-report" -reporttypes:Html
      - echo "âœ… Completing SonarCloud analysis..."
      - dotnet sonarscanner end /d:sonar.token="$SONAR_TOKEN"

  post_build:
    commands:
      - echo "ğŸš€ Publishing app..."
      - dotnet publish ./TestApi/TestApi.csproj -c Release -o out
      - echo "ğŸ“¦ Build complete. Artifacts are ready."

artifacts:
  files:
    - appspec.yml
    - deploy-scripts/**     # Includes all deployment scripts
    - systemd/**            # Includes systemd service files
    - out/**/*              # .NET published app
    - coverage-report/**    # Code coverage HTML report
    - coverage-report/index.html
